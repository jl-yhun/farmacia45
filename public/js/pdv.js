var busquedaTime,productos=[],descuentos=[],descuento={},total=0,cobrando=!1,recalcularDescuento=function(e){var t=e.find("input[name='total']"),o=JSON.parse(decodeURIComponent(e.find("input[name='producto']").val())),n=e.find("select[name='tipo_descuento']").val(),a=parseFloat(e.find("input[name='descuento_valor']:visible").val()),d=e.find("textarea[name='motivo']").val();a=isNaN(a)?0:a;var c=0,i=(c="monto"==n?parseFloat(o.venta-a).toFixed(2):parseFloat(Math.ceil(o.venta*(1-a/100))).toFixed(2))<parseFloat(o.compra);e.find(".btn-realizar-descuento").attr("disabled",i),i?alerta("No se puede hacer un descuento tan alto<br>Corrija para continuar","warning"):$(".js-generated").fadeOut(),t.val(c),descuento={id:o.id,motivo:d,descuento:a,nuevo:c,tipo:n}},recargarCuenta=function(){$(".cuenta").html(""),$("#busqueda").val("").trigger("focus"),total=0;for(var e=productos.length-1;e>=0;e--){var t=descuentos.find((t=>t.id==productos[e].id)),o="";void 0!==t&&(o="monto"==t.tipo?`<span class='descuento'>\n                            -$${t.descuento}\n                        </span>`:`<span class='descuento'>\n                            -${t.descuento}%\n                        </span>`),$(".cuenta").append(`<div class='row item'><div class='col-1 text-center'><i class='material-icons producto-eliminar' data-id='${productos[e].id}'>close</i></div>\n            <div class='col-md-5 col-11 text-center text-md-left'>${productos[e].nombre}<br>\n                <sub>${productos[e].descripcion}</sub>\n            </div>\n            <div class='col-md-2 col-4 producto-venta' data-id='${productos[e].id}'>\n                $${productos[e].venta}\n                ${o}\n            </div>\n            <div class='col-md-2 col-4 producto-cantidad' data-id='${productos[e].id}'>${productos[e].cantidad}</div>\n            <div class='col-md-2 col-4 text-right'>$${(productos[e].venta*productos[e].cantidad).toFixed(2)}</div>\n            </div><hr>`),total+=parseFloat(productos[e].venta*productos[e].cantidad)}$(".total-cuenta").find("b:nth-child(2)").text("$"+total.toFixed(2)),$(document).off("dblclick").on("dblclick",".producto-cantidad",(function(e){e.preventDefault();var t=$(this).text(),o=$(this).attr("data-id");$(this).text("");var n="<input type='text' class='form-control cantidad-input onlynumbers' value='"+t+"'></input>";$(this).html(n),$(document).off("keypress",".cantidad-input").on("keypress",".cantidad-input",(function(e){if(13==e.which){var t=parseInt($(this).val());if(0==t)return;var n=productos.findIndex((e=>e.id==o));hasStock(productos[n],t)||(t=productos[n].cantidad),productos[n].cantidad=t,recargarCuenta(),$("#busqueda").focus()}}))})),$(document).off("dblclick",".producto-venta").on("dblclick",".producto-venta",(function(e){e.preventDefault();var t=$(this).attr("data-id");abrirModal($("#ruta-descuento").val()+`/${t}`,"GET","md",!1,"",(function(e){var o=descuentos.findIndex((e=>e.id==t));if(e.find("select[name='tipo_descuento']").off("change").on("change",(function(){var t=$(this).val();$(".descuento_tipo").addClass("d-none"),$(`.descuento_${t}`).removeClass("d-none"),recalcularDescuento(e)})),o>=0){var n=descuentos[o];e.find(`select[name='tipo_descuento'] option[value='${n.tipo}']`).attr("selected",!0),e.find("select[name='tipo_descuento']").trigger("change"),e.find("input[name='descuento_valor']").val(n.descuento),e.find("input[name='total']").val(n.nuevo),e.find("textarea[name='motivo']").val(n.motivo)}e.off("keyup","input[name='descuento_valor']").on("keyup","input[name='descuento_valor']",(function(t){recalcularDescuento(e)})),e.find("textarea[name='motivo']").off("change").on("change",(function(t){recalcularDescuento(e)})),e.find(".btn-realizar-descuento").off("click").on("click",(function(n){if(n.preventDefault(),n.stopPropagation(),0!==Object.keys(descuento).length)if(""!=descuento.motivo&&0!=descuento.descuento){o>=0?0==descuento.descuento?descuentos.splice(o,1):descuentos[o]=descuento:descuentos.push(descuento),e.modal("hide");var a=productos.findIndex((e=>e.id==t));productos[a].venta=descuento.nuevo,descuento={},recargarCuenta(),$("#busqueda").focus()}else alerta("Complete el formulario para continuar","danger");else alerta("Complete el formulario para continuar","danger")}))}))})),$(document).off("click",".producto-eliminar").on("click",".producto-eliminar",(function(){var e=$(this).attr("data-id"),t=productos.findIndex((t=>t.id==e));productos.splice(t,1),recargarCuenta()}))};const hasStock=(e,t=0)=>{const o=e.stock-t>=0;return o||alerta("Producto sin stock disponible","danger"),o};$((function(){$("body").on("keydown",(function(e){121==e.which?(e.preventDefault(),$(".btn-cobrar").trigger("click"),cobrando=!0):27==e.which&&$(".js-generated").fadeOut((function(){$(this).remove()}))})),$("#busqueda").on("keydown",(function(t){if(38==t.which||13==t.which){if(t.preventDefault(),""==$(this).val())return;e($(this).val())}})),$("#btnBuscar").on("click",(function(t){t.preventDefault(),e($("#busqueda").val())}));var e=function(e){$.ajax({type:"POST",url:$("#ruta-buscar").val(),data:{busqueda:e},success:function(e){if(isMobile){var o=$("#modal-general");o.find(".modal-content").html("").html(e),o.modal("show"),o.off("hidden.bs.modal").on("hidden.bs.modal",(function(){$("#busqueda").focus()})),o.find(".tabla-productos .producto").on("click",(function(){t(this),o.modal("hide"),$("#busqueda").val("")}))}else $("#resultados tbody").html(e),1==$("#resultados tbody tr").length&&t($("#resultados tbody tr").first()),$("#resultados tbody").find(".producto").on("click",(function(){t(this)}))}})},t=function(e){var t=JSON.parse($(e).attr("data-producto"));t.cantidad=1;var o=productos.findIndex((e=>e.id==t.id));if(-1!=o){if(!hasStock(t,productos[o].cantidad+1))return;productos[o].cantidad+=1}else{if(!hasStock(t,t.cantidad))return;productos.push(t)}recargarCuenta()};$(".btn-cobrar").off("click").on("click",(function(){0!=productos.length?cobrando||(cobrando=!0,abrirModal("/caja/cobro","GET","md",!1,"",(function(e){e.off("hidden.bs.modal").on("hidden.bs.modal",(function(){cobrando=!1})),e.find(".total").text("$"+total.toFixed(2)),e.find("input[name='total']").val(total.toFixed(2));for(var t=0;t<productos.length;t++)e.find("form").append("<input type='hidden' name='productos["+t+"][cantidad]' value='"+productos[t].cantidad+"'>"),e.find("form").append("<input type='hidden' name='productos["+t+"][venta]' value='"+productos[t].venta+"'>"),e.find("form").append("<input type='hidden' name='productos["+t+"][id]' value='"+productos[t].id+"'>");for(t=0;t<descuentos.length;t++)e.find("form").append(`<input type='hidden' name='descuentos[${t}][motivo]' value='${descuentos[t].motivo}'>`),e.find("form").append(`<input type='hidden' name='descuentos[${t}][id]' value='${descuentos[t].id}'>`),e.find("form").append(`<input type='hidden' name='descuentos[${t}][descuento]' value='${descuentos[t].descuento}'>`),e.find("form").append(`<input type='hidden' name='descuentos[${t}][nuevo]' value='${descuentos[t].nuevo}'>`),e.find("form").append(`<input type='hidden' name='descuentos[${t}][tipo]' value='${descuentos[t].tipo}'>`);e.modal("show"),e.find(".se-recibe").val(""),setTimeout((function(){e.find(".se-recibe").trigger("focus")}),500),e.find(".cambio").text("$0.00"),$(document).off("keyup",".se-recibe").on("keyup",".se-recibe",(function(t){13==t.which&&$(".btn-realizar-cobro").trigger("click");var o=$(this).val();e.find(".cambio").text("$"+(o-total).toFixed(2))}))}))):alerta("Debe ingresar al menos 1 producto","danger")})),$(".btn-imprimir-ultima").off("click").on("click",(function(){$.ajax({type:"GET",url:$("#ruta-reimprimir-ultima-venta").val(),success:function(e){imprimirTicketVenta({id:e},(function(){alerta("Se ha impreso el ticket","success")}),(function(){alerta("No se pudo imprimir el ticket, consulte con soporte","danger")}))}})})),$(".btn-imprimir-ultimo-corte").off("click").on("click",(function(){$.ajax({type:"GET",url:$("#ruta-reimprimir-ultimo-corte").val(),success:function(e){imprimirTicketCorte(e)},complete:function(){setTimeout((function(){location.reload()}),2e3)}})})),$(document).off("change","select[name='metodo_pago']").on("change","select[name='metodo_pago']",(function(){"Efectivo"!==$(this).val()?$("#controles-efectivo").addClass("d-none"):$("#controles-efectivo").removeClass("d-none")}))}));
