$((function(){try{$("#table").DataTable(),$("#table_filter input").attr("data-cy","txt-busqueda"),$("#table").attr("data-cy","tbl"),$("#table_length select").attr("data-cy","select-length"),$("#table_paginate").attr("data-cy","paginacion"),$("#table_info").attr("data-cy","paginacion-info")}catch(t){console.error(t)}$(document).off("click",".btnEliminar").on("click",".btnEliminar",(function(t){t.preventDefault(),bootbox.confirm("¿Seguro que desea eliminar este registro?",(function(e){var n;e&&(n=$(t.target).find("form"),"i"==t.target.localName&&(n=$(t.target).parent().find("form")),n.trigger("submit"))}))})),$("body").on("keydown",(function(t){"F4"==t.key&&(t.preventDefault(),$("#btn-agregar").trigger("click"))}))}));var nuevosProductos=[],montoFaltante=0;$((function(){var t=function(){if(""!=$("select[name='tipo']").val()&&"CANCELACIÓN"!=$("select[name='tipo']").val()){var t=$("input[name='venta_id']").val();abrirModal(`/garantia-venta/${t}`,"GET","lg",!0,"venta")}},e=function(t){if(!t.is("[readonly]"))if(montoFaltante<=0)alerta("Ya se cubrió el monto del producto devuelto.","info");else{var e=t.val(),n=$("input[name='producto_id']").val();abrirModal(`/garantia-productos/${e}/${n}`,"GET","lg",!0,"productos")}},n=function(){var t=$("#tabla_nuevos_productos"),e=parseFloat($("input[name='producto_monto']").val());t.find("tbody").html("");for(var n=0,o=0;o<nuevosProductos.length;o++)n+=nuevosProductos[o].venta*nuevosProductos[o].cantidad,t.find("tbody").append(`<tr producto-id='${nuevosProductos[o].id}'>\n                <input type='hidden' name='productos[${o}][id]' value='${nuevosProductos[o].id}'/>\n                <td>${nuevosProductos[o].nombre}</td>\n                <input type='hidden' name='productos[${o}][nombre]' value='${nuevosProductos[o].nombre}'/>\n                <td class='nuevo_producto_cantidad'>${nuevosProductos[o].cantidad}</td>\n                <input type='hidden' name='productos[${o}][cantidad]' value='${nuevosProductos[o].cantidad}'/>\n                <td>$ ${nuevosProductos[o].venta}</td>\n                <input type='hidden' name='productos[${o}][venta]' value='${nuevosProductos[o].venta}'/>\n                <td>$ ${nuevosProductos[o].venta*nuevosProductos[o].cantidad}</td>\n                <td>\n                    <button type='button' data-toggle='tooltip' title='Eliminar' class='btn btn-danger btn-eliminar'>\n                        <i class='fa fa-ban'></i>\n                    </button>\n                </td>\n            </tr>`);montoFaltante=e-n,$("input[name='diferencia']").val(montoFaltante),n>e&&alerta("El cliente deberá pagar una diferencia de $ "+(n-e),"info")};$(document).off("dblclick",".nuevo_producto_cantidad").on("dblclick",".nuevo_producto_cantidad",(function(t){var e=parseInt($(this).text());replaceWithInput($(this),(function(t,o){if(t.html(""),t.text(e),e<o&&montoFaltante<=0)alerta("Ya se cubrió el monto del producto devuelto.","info");else{t.html(""),t.text(o);var a=t.parent().attr("producto-id"),i=nuevosProductos.findIndex((t=>t.id==a));nuevosProductos[i].cantidad=o,nuevosProductos[i].monto=o*nuevosProductos[i].venta,n()}}))})),$(document).off("on-lov-selection").on("on-lov-selection",(function(t,e){switch(e.tipo){case"venta":var o=e.selected;if($("input[name='producto_nombre']").val(o.nombre),$("input[name='producto_id']").val(o.id),$("input[name='producto_monto']").val(o.pivot.venta),$("input[name='producto_admite']").val(o.categoria.admite),montoFaltante=parseFloat(o.pivot.venta),"NINGUNO"==o.categoria.admite)alerta("Se necesitará <b>permisos de administrador</b> para \n                            procesar esta devolución ya que este producto <b>NO ADMITE</b> cambios ni devoluciones","warning");else if(o.categoria.admite!==$("select[name='tipo']").val())return void alerta(`Este producto no admite <b>${$("select[name='tipo']").val()}.</b><br>\n                            Seleccione ${o.categoria.admite} para este producto.`,"warning");$("input[name='nuevo_producto']").removeAttr("readonly");break;case"productos":var a=e.selected,i=nuevosProductos.findIndex((t=>t.id==a.id));-1==i?nuevosProductos.push({id:a.id,nombre:a.nombre,venta:parseFloat(a.venta),cantidad:1,monto:parseFloat(a.venta)}):nuevosProductos[i].cantidad++,n()}})),$(document).off("keydown","input[name='venta_id'], input[name='nuevo_producto']").on("keydown","input[name='venta_id'], input[name='nuevo_producto']",(function(n){if("Enter"===n.code)switch(n.preventDefault(),n.target.name){case"venta_id":t();break;case"nuevo_producto":e($(this))}return!0})),$(document).off("change","select[name='tipo']").on("change","select[name='tipo']",(function(){var t=$(this).val();if($("#producto").removeClass("d-none"),$("#producto_monto").removeClass("d-none"),$("#cambios_garantias").removeClass("d-none"),$("#folio_venta .input-group-append").removeClass("d-none"),"DEVOLUCIÓN DE DINERO"==t)alerta("Se necesitará <b>permisos de administrador</b> para \n            procesar esta devolución.","warning"),$("#cambios_garantias").addClass("d-none");else if("CANCELACIÓN"==t)$("#cambios_garantias").addClass("d-none"),$("#producto").addClass("d-none"),$("#producto_monto").addClass("d-none"),$("#folio_venta .input-group-append").addClass("d-none");else if("GARANTÍA"==t||"CAMBIO"==t){var e=$("input[name='producto_admite']").val();if(e==t)$("input[name='nuevo_producto']").removeAttr("readonly");else if(""!==e)return alerta(`Este producto no admite <b>${t}.</b><br>\n                            Seleccione ${e} para este producto.`,"warning"),void $("input[name='nuevo_producto']").attr("readonly","readonly")}"GARANTÍA"==t?$("input[name='perdida']").val(1):$("input[name='perdida']").val(0),$("input[name='venta_id']").removeAttr("readonly")})),$(document).off("click",".btn-eliminar").on("click",".btn-eliminar",(function(t){t.preventDefault();var e=$(this).parent().parent().attr("producto-id"),o=nuevosProductos.findIndex((t=>t.id==e));nuevosProductos.splice(o,1),n()})),$(document).off("click",".btn-search-venta").on("click",".btn-search-venta",(function(e){e.preventDefault(),t()})),$(document).off("click",".btn-search-producto").on("click",".btn-search-producto",(function(t){t.preventDefault(),e($(this).parent().parent().find("input"))})),$(document).off("click",".btn-imprimir").on("click",".btn-imprimir",(function(t){t.preventDefault();var e=$(this).attr("data-id");imprimirTicketGarantia({id:e})}))}));
